// SPDX-License-Identifier: MIT

pragma solidity ^0.6.0;
pragma experimental ABIEncoderV2;

import "./IERC20.sol";
import "./SafeERC20.sol";
import "./Math.sol";
import "./ITornadoInstance.sol";
import "./ITornadoTrees.sol";

contract TornadoProxy {
  using SafeERC20 for IERC20;

  event EncryptedNote(address indexed sender, bytes encryptedNote);
  event InstanceStateUpdate(ITornadoInstance indexed instance, InstanceState state);

  enum InstanceState { Disabled, Enabled, Mineable }

  struct Instance {
    bool isERC20;
    IERC20 token;
    InstanceState state;
  }

  struct Tornado {
    ITornadoInstance addr;
    Instance instance;
  }

  ITornadoTrees public tornadoTrees;
  address public immutable governance;
  mapping(ITornadoInstance => Instance) public instances;

  modifier onlyGovernance() {
    require(msg.sender == governance, "Not authorized");
    _;
  }

  constructor(
    // address _tornadoTrees,
    address _governance
    // Tornado[] memory _instances
  ) public {
    // tornadoTrees = ITornadoTrees(_tornadoTrees);
    governance = _governance;

    // for (uint256 i = 0; i < _instances.length; i++) {
    //   _updateInstance(_instances[i]);
    // }

    Tornado memory instance;
    instance.addr = ITornadoInstance(0x67698727EEF9fe6D5DC1A48aF1C4935F36975a2F);
    instance.instance.isERC20 = false;
    instance.instance.token = IERC20(0x0000000000000000000000000000000000000000);
    instance.instance.state = InstanceState.Enabled;

    _updateInstance(instance);
  }

  function deposit(
    ITornadoInstance _tornado,
    bytes32 _commitment,
    bytes calldata _encryptedNote
  ) external payable {
    Instance memory instance = instances[_tornado];
    require(instance.state != InstanceState.Disabled, "The instance is not supported");

    if (instance.isERC20) {
      instance.token.safeTransferFrom(msg.sender, address(this), _tornado.denomination());
    }
    _tornado.deposit{ value: msg.value }(_commitment);

    // if (instance.state == InstanceState.Mineable) {
    //   tornadoTrees.registerDeposit(address(_tornado), _commitment);
    // }
    emit EncryptedNote(msg.sender, _encryptedNote);
  }

  function withdraw(
    ITornadoInstance _tornado,
    bytes calldata _proof,
    bytes32 _root,
    bytes32 _nullifierHash,
    address payable _recipient,
    address payable _relayer,
    uint256 _fee,
    uint256 _refund
  ) external payable {
    Instance memory instance = instances[_tornado];
    require(instance.state != InstanceState.Disabled, "The instance is not supported");

    _tornado.withdraw{ value: msg.value }(_proof, _root, _nullifierHash, _recipient, _relayer, _fee, _refund);
    // if (instance.state == InstanceState.Mineable) {
    //   tornadoTrees.registerWithdrawal(address(_tornado), _nullifierHash);
    // }
  }

  function backupNotes(bytes[] calldata _encryptedNotes) external {
    for (uint256 i = 0; i < _encryptedNotes.length; i++) {
      emit EncryptedNote(msg.sender, _encryptedNotes[i]);
    }
  }

  function updateInstance(Tornado calldata _tornado) external onlyGovernance {
    _updateInstance(_tornado);
  }

  function setTornadoTreesContract(address _tornadoTrees) external onlyGovernance {
    tornadoTrees = ITornadoTrees(_tornadoTrees);
  }

  /// @dev Method to claim junk and accidentally sent tokens
  function rescueTokens(
    IERC20 _token,
    address payable _to,
    uint256 _balance
  ) external onlyGovernance {
    require(_to != address(0), "TORN: can not send to zero address");

    if (_token == IERC20(0)) {
      // for Ether
      uint256 totalBalance = address(this).balance;
      uint256 balance = _balance == 0 ? totalBalance : Math.min(totalBalance, _balance);
      _to.transfer(balance);
    } else {
      // any other erc20
      uint256 totalBalance = _token.balanceOf(address(this));
      uint256 balance = _balance == 0 ? totalBalance : Math.min(totalBalance, _balance);
      require(balance > 0, "TORN: trying to send 0 balance");
      _token.safeTransfer(_to, balance);
    }
  }

  function _updateInstance(Tornado memory _tornado) internal {
    instances[_tornado.addr] = _tornado.instance;
    if (_tornado.instance.isERC20) {
      IERC20 token = IERC20(_tornado.addr.token());
      require(token == _tornado.instance.token, "Incorrect token");
      uint256 allowance = token.allowance(address(this), address(_tornado.addr));

      if (_tornado.instance.state != InstanceState.Disabled && allowance == 0) {
        token.safeApprove(address(_tornado.addr), uint256(-1));
      } else if (_tornado.instance.state == InstanceState.Disabled && allowance != 0) {
        token.safeApprove(address(_tornado.addr), 0);
      }
    }
    emit InstanceStateUpdate(_tornado.addr, _tornado.instance.state);
  }
}
60a06040523480156200001157600080fd5b5060405162001e9138038062001e91833981016040819052620000349162000694565b6001600160601b0319606082901b166080526200005062000649565b7367698727eef9fe6d5dc1a48af1c4935f36975a2f815260208082018051600090819052815190920191909152516001604090910152620000918162000099565b505062000913565b60208181015182516001600160a01b03908116600090815260018452604090819020835181549585015160ff1990961690151517610100600160a81b0319166101009590931694909402919091178084559082015191929190829060ff60a81b1916600160a81b8360028111156200010d57fe5b02179055505050602081015151156200031e57600081600001516001600160a01b031663fc0c546a6040518163ffffffff1660e01b815260040160206040518083038186803b1580156200016057600080fd5b505afa15801562000175573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200019b919062000694565b90508160200151602001516001600160a01b0316816001600160a01b031614620001e25760405162461bcd60e51b8152600401620001d990620007d9565b60405180910390fd5b8151604051636eb1769f60e11b81526000916001600160a01b0384169163dd62ed3e91620002169130919060040162000716565b60206040518083038186803b1580156200022f57600080fd5b505afa15801562000244573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200026a9190620006df565b9050600083602001516040015160028111156200028357fe5b1415801562000290575080155b15620002c757620002c18360000151600019846001600160a01b03166200037060201b620007ed179092919060201c565b6200031b565b60008360200151604001516002811115620002de57fe5b148015620002eb57508015155b156200031b576200031b83600001516000846001600160a01b03166200037060201b620007ed179092919060201c565b50505b80600001516001600160a01b03167f18f6d0a42d18071db7c44ddedf23de9f7ce6e1efad25f7e6a42739d16b34c39982602001516040015160405162000365919062000749565b60405180910390a250565b801580620003ff5750604051636eb1769f60e11b81526001600160a01b0384169063dd62ed3e90620003a9903090869060040162000716565b60206040518083038186803b158015620003c257600080fd5b505afa158015620003d7573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620003fd9190620006df565b155b6200041e5760405162461bcd60e51b8152600401620001d99062000883565b620004798363095ea7b360e01b84846040516024016200044092919062000730565b60408051808303601f190181529190526020810180516001600160e01b0319939093166001600160e01b03938416179052906200047e16565b505050565b6060620004da826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b03166200051a60201b620008e7179092919060201c565b805190915015620004795780806020019051810190620004fb9190620006bd565b620004795760405162461bcd60e51b8152600401620001d99062000839565b60606200052b848460008562000535565b90505b9392505050565b6060824710156200055a5760405162461bcd60e51b8152600401620001d99062000793565b620005658562000605565b620005845760405162461bcd60e51b8152600401620001d99062000802565b60006060866001600160a01b03168587604051620005a39190620006f8565b60006040518083038185875af1925050503d8060008114620005e2576040519150601f19603f3d011682016040523d82523d6000602084013e620005e7565b606091505b509092509050620005fa8282866200060b565b979650505050505050565b3b151590565b606083156200061c5750816200052e565b8251156200062d5782518084602001fd5b8160405162461bcd60e51b8152600401620001d991906200075e565b604051806040016040528060006001600160a01b031681526020016200066e62000673565b905290565b6040805160608101825260008082526020820181905290918201906200066e565b600060208284031215620006a6578081fd5b81516001600160a01b03811681146200052e578182fd5b600060208284031215620006cf578081fd5b815180151581146200052e578182fd5b600060208284031215620006f1578081fd5b5051919050565b600082516200070c818460208701620008e0565b9190910192915050565b6001600160a01b0392831681529116602082015260400190565b6001600160a01b03929092168252602082015260400190565b60208101600383106200075857fe5b91905290565b60006020825282518060208401526200077f816040850160208701620008e0565b601f01601f19169190910160400192915050565b60208082526026908201527f416464726573733a20696e73756666696369656e742062616c616e636520666f6040820152651c8818d85b1b60d21b606082015260800190565b6020808252600f908201526e24b731b7b93932b1ba103a37b5b2b760891b604082015260600190565b6020808252601d908201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000604082015260600190565b6020808252602a908201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e6040820152691bdd081cdd58d8d9595960b21b606082015260800190565b60208082526036908201527f5361666545524332303a20617070726f76652066726f6d206e6f6e2d7a65726f60408201527f20746f206e6f6e2d7a65726f20616c6c6f77616e636500000000000000000000606082015260800190565b60005b83811015620008fd578181015183820152602001620008e3565b838111156200090d576000848401525b50505050565b60805160601c61155162000940600039806103c9528061057e52806105e0528061078e52506115516000f3fe6080604052600436106100865760003560e01c80636485ba2a116100595780636485ba2a1461010f578063b438689f1461012f578063cc6dc66814610142578063cea9d26f14610162578063e2658c9c1461018257610086565b8063032bb4431461008b57806313d98d13146100c35780633cb837fd146100d85780635aa6e675146100fa575b600080fd5b34801561009757600080fd5b506100ab6100a6366004610de6565b6101a2565b6040516100ba93929190611152565b60405180910390f35b6100d66100d1366004610ee9565b6101d2565b005b3480156100e457600080fd5b506100ed6103b8565b6040516100ba91906110e7565b34801561010657600080fd5b506100ed6103c7565b34801561011b57600080fd5b506100d661012a366004610e1e565b6103eb565b6100d661013d366004610f43565b610459565b34801561014e57600080fd5b506100d661015d366004610fe4565b610573565b34801561016e57600080fd5b506100d661017d366004610ea9565b6105d5565b34801561018e57600080fd5b506100d661019d366004610de6565b610783565b60016020526000908152604090205460ff808216916001600160a01b0361010082041691600160a81b9091041683565b6101da610d81565b6001600160a01b038086166000908152600160209081526040918290208251606081018452815460ff80821615158352610100820490961693820193909352939092840191600160a81b900416600281111561023257fe5b600281111561023d57fe5b905250905060008160400151600281111561025457fe5b141561027b5760405162461bcd60e51b8152600401610272906112a6565b60405180910390fd5b80511561030e5761030e3330876001600160a01b0316638bca6d166040518163ffffffff1660e01b815260040160206040518083038186803b1580156102c057600080fd5b505afa1580156102d4573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906102f89190611089565b60208501516001600160a01b0316929190610900565b60405163b214faa560e01b81526001600160a01b0386169063b214faa590349061033c908890600401611180565b6000604051808303818588803b15801561035557600080fd5b505af1158015610369573d6000803e3d6000fd5b5050505050336001600160a01b03167ffa28df43db3553771f7209dcef046f3bdfea15870ab625dcda30ac58b82b400884846040516103a9929190611189565b60405180910390a25050505050565b6000546001600160a01b031681565b7f000000000000000000000000000000000000000000000000000000000000000081565b60005b8181101561045457337ffa28df43db3553771f7209dcef046f3bdfea15870ab625dcda30ac58b82b400884848481811061042457fe5b90506020028101906104369190611455565b604051610444929190611189565b60405180910390a26001016103ee565b505050565b610461610d81565b6001600160a01b03808b166000908152600160209081526040918290208251606081018452815460ff80821615158352610100820490961693820193909352939092840191600160a81b90041660028111156104b957fe5b60028111156104c457fe5b90525090506000816040015160028111156104db57fe5b14156104f95760405162461bcd60e51b8152600401610272906112a6565b6040516310d056db60e11b81526001600160a01b038b16906321a0adb6903490610535908d908d908d908d908d908d908d908d9060040161119d565b6000604051808303818588803b15801561054e57600080fd5b505af1158015610562573d6000803e3d6000fd5b505050505050505050505050505050565b336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146105bb5760405162461bcd60e51b81526004016102729061142d565b6105d26105cd36839003830183610ffb565b610927565b50565b336001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000161461061d5760405162461bcd60e51b81526004016102729061142d565b6001600160a01b0382166106435760405162461bcd60e51b815260040161027290611314565b6001600160a01b0383166106ac574760008215610669576106648284610bb9565b61066b565b815b6040519091506001600160a01b0385169082156108fc029083906000818181858888f193505050501580156106a4573d6000803e3d6000fd5b505050610454565b6040516370a0823160e01b81526000906001600160a01b038516906370a08231906106db9030906004016110e7565b60206040518083038186803b1580156106f357600080fd5b505afa158015610707573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061072b9190611089565b9050600082156107445761073f8284610bb9565b610746565b815b9050600081116107685760405162461bcd60e51b8152600401610272906113a0565b61077c6001600160a01b0386168583610bcf565b5050505050565b336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146107cb5760405162461bcd60e51b81526004016102729061142d565b600080546001600160a01b0319166001600160a01b0392909216919091179055565b8015806108755750604051636eb1769f60e11b81526001600160a01b0384169063dd62ed3e9061082390309086906004016110fb565b60206040518083038186803b15801561083b57600080fd5b505afa15801561084f573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108739190611089565b155b6108915760405162461bcd60e51b8152600401610272906113d7565b6104548363095ea7b360e01b84846040516024016108b0929190611139565b60408051601f198184030181529190526020810180516001600160e01b03166001600160e01b031990931692909217909152610bee565b60606108f68484600085610c7d565b90505b9392505050565b610921846323b872dd60e01b8585856040516024016108b093929190611115565b50505050565b60208181015182516001600160a01b03908116600090815260018452604090819020835181549585015160ff1990961690151517610100600160a81b0319166101009590931694909402919091178084559082015191929190829060ff60a81b1916600160a81b83600281111561099a57fe5b0217905550505060208101515115610b6957600081600001516001600160a01b031663fc0c546a6040518163ffffffff1660e01b815260040160206040518083038186803b1580156109eb57600080fd5b505afa1580156109ff573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a239190610e02565b90508160200151602001516001600160a01b0316816001600160a01b031614610a5e5760405162461bcd60e51b81526004016102729061127d565b8151604051636eb1769f60e11b81526000916001600160a01b0384169163dd62ed3e91610a90913091906004016110fb565b60206040518083038186803b158015610aa857600080fd5b505afa158015610abc573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610ae09190611089565b905060008360200151604001516002811115610af857fe5b14158015610b04575080155b15610b27578251610b22906001600160a01b038416906000196107ed565b610b66565b60008360200151604001516002811115610b3d57fe5b148015610b4957508015155b15610b66578251610b66906001600160a01b0384169060006107ed565b50505b80600001516001600160a01b03167f18f6d0a42d18071db7c44ddedf23de9f7ce6e1efad25f7e6a42739d16b34c399826020015160400151604051610bae91906111ef565b60405180910390a250565b6000818310610bc857816108f9565b5090919050565b6104548363a9059cbb60e01b84846040516024016108b0929190611139565b6060610c43826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b03166108e79092919063ffffffff16565b8051909150156104545780806020019051810190610c619190610e8d565b6104545760405162461bcd60e51b815260040161027290611356565b606082471015610c9f5760405162461bcd60e51b815260040161027290611237565b610ca885610d3e565b610cc45760405162461bcd60e51b8152600401610272906112dd565b60006060866001600160a01b03168587604051610ce191906110cb565b60006040518083038185875af1925050503d8060008114610d1e576040519150601f19603f3d011682016040523d82523d6000602084013e610d23565b606091505b5091509150610d33828286610d48565b979650505050505050565b803b15155b919050565b60608315610d575750816108f9565b825115610d675782518084602001fd5b8160405162461bcd60e51b81526004016102729190611204565b60408051606081018252600080825260208201819052909182015290565b60008083601f840112610db0578182fd5b50813567ffffffffffffffff811115610dc7578182fd5b602083019150836020828501011115610ddf57600080fd5b9250929050565b600060208284031215610df7578081fd5b81356108f9816114f8565b600060208284031215610e13578081fd5b81516108f9816114f8565b60008060208385031215610e30578081fd5b823567ffffffffffffffff80821115610e47578283fd5b818501915085601f830112610e5a578283fd5b813581811115610e68578384fd5b8660208083028501011115610e7b578384fd5b60209290920196919550909350505050565b600060208284031215610e9e578081fd5b81516108f98161150d565b600080600060608486031215610ebd578081fd5b8335610ec8816114f8565b92506020840135610ed8816114f8565b929592945050506040919091013590565b60008060008060608587031215610efe578081fd5b8435610f09816114f8565b935060208501359250604085013567ffffffffffffffff811115610f2b578182fd5b610f3787828801610d9f565b95989497509550505050565b60008060008060008060008060006101008a8c031215610f61578485fd5b8935610f6c816114f8565b985060208a013567ffffffffffffffff811115610f87578586fd5b610f938c828d01610d9f565b90995097505060408a0135955060608a0135945060808a0135610fb5816114f8565b935060a08a0135610fc5816114f8565b8093505060c08a0135915060e08a013590509295985092959850929598565b600060808284031215610ff5578081fd5b50919050565b6000818303608081121561100d578182fd5b611017604061149a565b8335611022816114f8565b81526060601f1983011215611035578283fd5b61103f606061149a565b9150602084013561104f8161150d565b8252604084013561105f816114f8565b6020830152606084013560038110611075578384fd5b604083015260208101919091529392505050565b60006020828403121561109a578081fd5b5051919050565b60008284528282602086013780602084860101526020601f19601f85011685010190509392505050565b600082516110dd8184602087016114cc565b9190910192915050565b6001600160a01b0391909116815260200190565b6001600160a01b0392831681529116602082015260400190565b6001600160a01b039384168152919092166020820152604081019190915260600190565b6001600160a01b03929092168252602082015260400190565b83151581526001600160a01b038316602082015260608101611173836114c1565b6040830152949350505050565b90815260200190565b6000602082526108f66020830184866110a1565b600060e082526111b160e083018a8c6110a1565b60208301989098525060408101959095526001600160a01b03938416606086015291909216608084015260a083019190915260c09091015292915050565b602081016111fc836114c1565b825292915050565b60006020825282518060208401526112238160408501602087016114cc565b601f01601f19169190910160400192915050565b60208082526026908201527f416464726573733a20696e73756666696369656e742062616c616e636520666f6040820152651c8818d85b1b60d21b606082015260800190565b6020808252600f908201526e24b731b7b93932b1ba103a37b5b2b760891b604082015260600190565b6020808252601d908201527f54686520696e7374616e6365206973206e6f7420737570706f72746564000000604082015260600190565b6020808252601d908201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000604082015260600190565b60208082526022908201527f544f524e3a2063616e206e6f742073656e6420746f207a65726f206164647265604082015261737360f01b606082015260800190565b6020808252602a908201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e6040820152691bdd081cdd58d8d9595960b21b606082015260800190565b6020808252601e908201527f544f524e3a20747279696e6720746f2073656e6420302062616c616e63650000604082015260600190565b60208082526036908201527f5361666545524332303a20617070726f76652066726f6d206e6f6e2d7a65726f60408201527520746f206e6f6e2d7a65726f20616c6c6f77616e636560501b606082015260800190565b6020808252600e908201526d139bdd08185d5d1a1bdc9a5e995960921b604082015260600190565b6000808335601e1984360301811261146b578283fd5b83018035915067ffffffffffffffff821115611485578283fd5b602001915036819003821315610ddf57600080fd5b60405181810167ffffffffffffffff811182821017156114b957600080fd5b604052919050565b8060038110610d4357fe5b60005b838110156114e75781810151838201526020016114cf565b838111156109215750506000910152565b6001600160a01b03811681146105d257600080fd5b80151581146105d257600080fdfe